name: "VULN-3: Mass Assignment Check"

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

env:
  API_URL: ${{ vars.API_URL }}

jobs:
  check-mass-assignment:
    name: "Check Mass Assignment (isVerified / role)"
    runs-on: ubuntu-latest
    steps:
      - name: Login as Charlie (contractor)
        id: login
        run: |
          API=${API_URL:-http://localhost:3001}
          RESPONSE=$(curl -s -X POST "$API/api/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"charlie@contractor.com","password":"Password123!"}')
          TOKEN=$(echo $RESPONSE | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['data']['token'])")
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Attempt to self-elevate role to admin
        run: |
          API=${API_URL:-http://localhost:3001}
          curl -s -X PUT "$API/api/contractors/bbbbbbbb-0000-0000-0000-000000000001" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ steps.login.outputs.token }}" \
            -d '{"role":"admin","isVerified":true,"hourlyRate":50}'

      - name: Check if role was accepted
        id: verify
        run: |
          API=${API_URL:-http://localhost:3001}
          RESPONSE=$(curl -s "$API/api/contractors/bbbbbbbb-0000-0000-0000-000000000001" \
            -H "Authorization: Bearer ${{ steps.login.outputs.token }}")
          ROLE=$(echo $RESPONSE | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('data',{}).get('role','unknown'))" 2>/dev/null || echo "unknown")
          VERIFIED=$(echo $RESPONSE | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('data',{}).get('isVerified',False))" 2>/dev/null || echo "false")
          echo "role=$ROLE" >> $GITHUB_OUTPUT
          echo "verified=$VERIFIED" >> $GITHUB_OUTPUT

      - name: Evaluate result
        run: |
          ROLE="${{ steps.verify.outputs.role }}"
          VERIFIED="${{ steps.verify.outputs.verified }}"
          if [ "$ROLE" = "admin" ] || [ "$VERIFIED" = "True" ] || [ "$VERIFIED" = "true" ]; then
            echo "::error::VULN-3 CONFIRMED: Mass Assignment! Contractor self-elevated to role=$ROLE, isVerified=$VERIFIED. Fix: whitelist allowed update fields in ContractorService.updateContractor()"
            echo "## VULN-3 Mass Assignment Detected" >> $GITHUB_STEP_SUMMARY
            echo "**Fix:** Strip role and isVerified from update payload. Only allow: specialty, bio, hourlyRate." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "Mass assignment check passed - privileged fields rejected"
            echo "## Mass Assignment Check Passed" >> $GITHUB_STEP_SUMMARY
          fi