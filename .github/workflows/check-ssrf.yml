name: "VULN-10: SSRF Check"

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

env:
  API_URL: ${{ vars.API_URL }}

jobs:
  check-ssrf:
    name: "Check SSRF via Contractor Webhook URL"
    runs-on: ubuntu-latest
    steps:
      - name: Login as Charlie (contractor)
        id: login
        run: |
          API=${API_URL:-http://localhost:3001}
          RESPONSE=$(curl -s -X POST "$API/api/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"charlie@contractor.com","password":"Password123!"}')
          TOKEN=$(echo $RESPONSE | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['data']['token'])")
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Set webhook to Azure IMDS endpoint (SSRF probe)
        id: ssrf_test
        run: |
          API=${API_URL:-http://localhost:3001}
          STATUS=$(curl -s -o /tmp/webhook_response.txt -w "%{http_code}" \
            -X POST "$API/api/contractors/webhook" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ steps.login.outputs.token }}" \
            -d '{"webhookUrl":"http://169.254.169.254/metadata/instance?api-version=2021-02-01"}')
          RESPONSE=$(cat /tmp/webhook_response.txt)
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "Response preview: ${RESPONSE:0:300}"
          if echo "$RESPONSE" | grep -q "compute\|subscriptionId\|resourceGroup"; then
            echo "leaked=true" >> $GITHUB_OUTPUT
          else
            echo "leaked=false" >> $GITHUB_OUTPUT
          fi

      - name: Evaluate result
        run: |
          STATUS="${{ steps.ssrf_test.outputs.status }}"
          LEAKED="${{ steps.ssrf_test.outputs.leaked }}"
          if [ "$LEAKED" = "true" ] || [ "$STATUS" = "200" ]; then
            echo "::error::VULN-10 CONFIRMED: SSRF! Server fetched Azure IMDS endpoint (HTTP $STATUS, metadata_leaked=$LEAKED). Fix: validate webhookUrl against allowlist"
            echo "## VULN-10 SSRF Detected" >> $GITHUB_STEP_SUMMARY
            echo "**Fix:** In ContractorService.triggerWebhook(), reject private IP ranges and require HTTPS with approved hostnames." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "SSRF check passed - server rejected internal URL (HTTP $STATUS)"
            echo "## SSRF Check Passed" >> $GITHUB_STEP_SUMMARY
          fi