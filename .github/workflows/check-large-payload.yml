name: "VULN-4: Large Payload DoS Check"

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

env:
  API_URL: ${{ vars.API_URL }}

jobs:
  check-large-payload:
    name: "Check Unrestricted File Upload Size"
    runs-on: ubuntu-latest
    steps:
      - name: Login as Alice
        id: login
        run: |
          API=${API_URL:-http://localhost:3001}
          RESPONSE=$(curl -s --connect-timeout 5 -X POST "$API/api/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"alice@propowner.com","password":"Password123!"}' 2>/dev/null || echo '{}')
          TOKEN=$(echo "$RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('data',{}).get('token','SKIP'))" 2>/dev/null || echo 'SKIP')
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          if [ "$TOKEN" = "SKIP" ]; then
            echo "⚠️ API not reachable at $API — skipping live probe"
          fi

      - name: Generate a 20MB test file
        run: dd if=/dev/urandom of=/tmp/large_file.bin bs=1M count=20 2>&1

      - name: Upload large file to attachments endpoint
        id: upload_test
        run: |
          if [ "${{ steps.login.outputs.token }}" = "SKIP" ] || [ -z "${{ steps.login.outputs.token }}" ]; then
            echo "status=SKIP" >> $GITHUB_OUTPUT
            exit 0
          fi
          API=${API_URL:-http://localhost:3001}
          JOB_ID="cccccccc-0000-0000-0000-000000000001"
          STATUS=$(curl -s --connect-timeout 5 -o /tmp/upload_response.txt -w "%{http_code}" \
            -H "Authorization: Bearer ${{ steps.login.outputs.token }}" \
            -F "file=@/tmp/large_file.bin" \
            "$API/api/jobs/$JOB_ID/attachments" 2>/dev/null || echo 'SKIP')
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "HTTP Status: $STATUS"
          cat /tmp/upload_response.txt 2>/dev/null || true

      - name: Evaluate result
        run: |
          STATUS="${{ steps.upload_test.outputs.status }}"

          if [ "$STATUS" = "SKIP" ] || [ -z "$STATUS" ]; then
            echo "## ⚠️ API Not Reachable in CI" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The live API at \`${API_URL:-http://localhost:3001}\` was not reachable from the GitHub Actions runner." >> $GITHUB_STEP_SUMMARY
            echo "**To enable live probing:** Set the \`API_URL\` repository variable (Settings → Variables) to a deployed staging URL." >> $GITHUB_STEP_SUMMARY
            echo "This check is **informational only** until a live API endpoint is configured." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          if [ "$STATUS" = "200" ] || [ "$STATUS" = "201" ]; then
            echo "::error::VULN-4 CONFIRMED: Large Payload DoS! Server accepted a 20MB file upload (HTTP $STATUS). Fix: add limits.fileSize to multer config"
            echo "## VULN-4 Large Payload DoS Detected" >> $GITHUB_STEP_SUMMARY
            echo "**Fix:** Add \`limits: { fileSize: 5 * 1024 * 1024 }\` to multer() in jobs route." >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [ "$STATUS" = "413" ]; then
            echo "Large payload check passed - server returned 413"
            echo "## Large Payload Check Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "Unexpected status $STATUS"
          fi
