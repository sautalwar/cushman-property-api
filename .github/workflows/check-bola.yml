name: "ðŸ”´ VULN-1: BOLA Check"

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

env:
  API_URL: ${{ vars.API_URL || 'http://localhost:3001' }}

jobs:
  check-bola:
    name: "Check Broken Object Level Authorization"
    runs-on: ubuntu-latest
    steps:
      - name: Login as Alice (resource owner)
        id: login_alice
        run: |
          RESPONSE=$(curl -s -X POST "$API_URL/api/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"alice@propowner.com","password":"Password123!"}')
          TOKEN=$(echo $RESPONSE | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['data']['token'])")
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          echo "âœ… Alice logged in successfully"

      - name: Login as Bob (different owner â€” the attacker)
        id: login_bob
        run: |
          RESPONSE=$(curl -s -X POST "$API_URL/api/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"bob@propowner.com","password":"Password123!"}')
          TOKEN=$(echo $RESPONSE | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['data']['token'])")
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          echo "âœ… Bob logged in successfully"

      - name: Bob attempts to read Alice's job (BOLA probe)
        id: bola_probe
        run: |
          JOB_ID="cccccccc-0000-0000-0000-000000000001"
          BODY=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer ${{ steps.login_bob.outputs.token }}" \
            "$API_URL/api/jobs/$JOB_ID")
          STATUS=$(echo "$BODY" | tail -1)
          JSON=$(echo "$BODY" | head -n -1)
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "body=$JSON"      >> $GITHUB_OUTPUT

          # Parse job attributes from the response body
          JOB_TITLE=$(echo "$JSON"   | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('data',{}).get('title','N/A'))"       2>/dev/null || echo "N/A")
          JOB_DESC=$(echo "$JSON"    | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('data',{}).get('description','N/A'))"  2>/dev/null || echo "N/A")
          JOB_STATUS=$(echo "$JSON"  | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('data',{}).get('status','N/A'))"       2>/dev/null || echo "N/A")
          OWNER_ID=$(echo "$JSON"    | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('data',{}).get('owner_id','N/A'))"     2>/dev/null || echo "N/A")
          PROP_ID=$(echo "$JSON"     | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('data',{}).get('property_id','N/A'))"  2>/dev/null || echo "N/A")

          echo "job_title=$JOB_TITLE"   >> $GITHUB_OUTPUT
          echo "job_desc=$JOB_DESC"     >> $GITHUB_OUTPUT
          echo "job_status=$JOB_STATUS" >> $GITHUB_OUTPUT
          echo "owner_id=$OWNER_ID"     >> $GITHUB_OUTPUT
          echo "prop_id=$PROP_ID"       >> $GITHUB_OUTPUT

          echo "HTTP $STATUS â€” Job: '$JOB_TITLE' | Owner: $OWNER_ID | Status: $JOB_STATUS"

      - name: Evaluate result and report
        run: |
          STATUS="${{ steps.bola_probe.outputs.status }}"
          JOB_TITLE="${{ steps.bola_probe.outputs.job_title }}"
          JOB_DESC="${{ steps.bola_probe.outputs.job_desc }}"
          JOB_STATUS="${{ steps.bola_probe.outputs.job_status }}"
          OWNER_ID="${{ steps.bola_probe.outputs.owner_id }}"
          PROP_ID="${{ steps.bola_probe.outputs.prop_id }}"

          if [ "$STATUS" = "200" ]; then
            echo "::error::VULN-1 CONFIRMED: BOLA vulnerability detected! Bob (bob@propowner.com) accessed Alice's job '$JOB_TITLE' (owner_id: $OWNER_ID) using his own token. Server returned HTTP 200. Fix: add AND owner_id = \$2 to WHERE clause in JobService.getJobById()"

            echo "## ðŸ”´ BOLA Vulnerability Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Attacker:** Bob (bob@propowner.com) â€” a different property owner" >> $GITHUB_STEP_SUMMARY
            echo "**Victim resource owner:** Alice (alice@propowner.com)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Exposed Job Details" >> $GITHUB_STEP_SUMMARY
            echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|---|---|" >> $GITHUB_STEP_SUMMARY
            echo "| Job Title | $JOB_TITLE |" >> $GITHUB_STEP_SUMMARY
            echo "| Description | $JOB_DESC |" >> $GITHUB_STEP_SUMMARY
            echo "| Job Status | $JOB_STATUS |" >> $GITHUB_STEP_SUMMARY
            echo "| Owner ID | $OWNER_ID |" >> $GITHUB_STEP_SUMMARY
            echo "| Property ID | $PROP_ID |" >> $GITHUB_STEP_SUMMARY
            echo "| HTTP Response | $STATUS OK âœ… (should be 403) |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Fix:** Add ownership check in JobService.getJobById(): \`WHERE id = \$1 AND owner_id = \$2\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… BOLA check passed â€” server returned HTTP $STATUS (access denied)"
            echo "## âœ… BOLA Check Passed" >> $GITHUB_STEP_SUMMARY
            echo "Bob's request to access Alice's job was correctly rejected with HTTP $STATUS." >> $GITHUB_STEP_SUMMARY
          fi


on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

env:
  API_URL: ${{ vars.API_URL || 'http://localhost:3001' }}

jobs:
  check-bola:
    name: "Check Broken Object Level Authorization"
    runs-on: ubuntu-latest
    steps:
      - name: Login as User A (Alice)
        id: login_a
        run: |
          RESPONSE=$(curl -s -X POST "$API_URL/api/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"alice@propowner.com","password":"Password123!"}'
          TOKEN=$(echo $RESPONSE | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['data']['token'])")
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Login as User B (Bob)
        id: login_b
        run: |
          RESPONSE=$(curl -s -X POST "$API_URL/api/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"bob@propowner.com","password":"Password123!"}'
          TOKEN=$(echo $RESPONSE | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['data']['token'])")
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: User B attempts to access User A's job
        id: bola_test
        run: |
          # Job ID owned by Alice
          JOB_ID="cccccccc-0000-0000-0000-000000000001"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ steps.login_b.outputs.token }}" \
            "$API_URL/api/jobs/$JOB_ID")
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "HTTP Status: $STATUS"

      - name: Evaluate result
        run: |
          STATUS="${{ steps.bola_test.outputs.status }}"
          if [ "$STATUS" = "200" ]; then
            echo "::error::VULN-1 CONFIRMED: BOLA vulnerability detected! User B accessed User A's job and received HTTP 200. Fix: add ownership check WHERE owner_id = requesting_user_id"
            echo "## ðŸ”´ BOLA Vulnerability Detected" >> $GITHUB_STEP_SUMMARY
            echo "User B successfully accessed User A's private job resource (HTTP $STATUS)." >> $GITHUB_STEP_SUMMARY
            echo "**Fix:** Add ownership check in JobService.getJobById(): \`WHERE id = \$1 AND owner_id = \$2\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… BOLA check passed â€” server returned $STATUS (access denied)"
            echo "## âœ… BOLA Check Passed" >> $GITHUB_STEP_SUMMARY
          fi
