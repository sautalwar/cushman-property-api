name: "ðŸ”´ VULN-1: BOLA Check"

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

env:
  API_URL: ${{ vars.API_URL || 'http://localhost:3001' }}

jobs:
  check-bola:
    name: "Check Broken Object Level Authorization"
    runs-on: ubuntu-latest
    steps:
      - name: Login as Alice (resource owner)
        id: login_alice
        run: |
          API=${API_URL:-http://localhost:3001}
          RESPONSE=$(curl -s --connect-timeout 5 -X POST "$API/api/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"alice@propowner.com","password":"Password123!"}' 2>/dev/null || echo '{}')
          TOKEN=$(echo "$RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('data',{}).get('token','SKIP'))" 2>/dev/null || echo 'SKIP')
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          if [ "$TOKEN" = "SKIP" ]; then
            echo "âš ï¸ API not reachable at $API â€” skipping live probe"
          else
            echo "âœ… Alice logged in successfully"
          fi

      - name: Login as Bob (different owner â€” the attacker)
        id: login_bob
        run: |
          API=${API_URL:-http://localhost:3001}
          RESPONSE=$(curl -s --connect-timeout 5 -X POST "$API/api/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"bob@propowner.com","password":"Password123!"}' 2>/dev/null || echo '{}')
          TOKEN=$(echo "$RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('data',{}).get('token','SKIP'))" 2>/dev/null || echo 'SKIP')
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          if [ "$TOKEN" = "SKIP" ]; then
            echo "âš ï¸ API not reachable at $API â€” skipping live probe"
          else
            echo "âœ… Bob logged in successfully"
          fi

      - name: Bob attempts to read Alice's job (BOLA probe)
        id: bola_probe
        run: |
          if [ "${{ steps.login_alice.outputs.token }}" = "SKIP" ] || [ -z "${{ steps.login_alice.outputs.token }}" ] || \
             [ "${{ steps.login_bob.outputs.token }}" = "SKIP" ] || [ -z "${{ steps.login_bob.outputs.token }}" ]; then
            echo "status=SKIP" >> $GITHUB_OUTPUT
            exit 0
          fi
          API=${API_URL:-http://localhost:3001}
          JOB_ID="cccccccc-0000-0000-0000-000000000001"
          BODY=$(curl -s --connect-timeout 5 -w "\n%{http_code}" \
            -H "Authorization: Bearer ${{ steps.login_bob.outputs.token }}" \
            "$API/api/jobs/$JOB_ID" 2>/dev/null || printf '\nSKIP')
          STATUS=$(echo "$BODY" | tail -1)
          JSON=$(echo "$BODY" | head -n -1)
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "body=$JSON"      >> $GITHUB_OUTPUT

          JOB_TITLE=$(echo "$JSON"   | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('data',{}).get('title','N/A'))"       2>/dev/null || echo "N/A")
          JOB_DESC=$(echo "$JSON"    | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('data',{}).get('description','N/A'))"  2>/dev/null || echo "N/A")
          JOB_STATUS=$(echo "$JSON"  | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('data',{}).get('status','N/A'))"       2>/dev/null || echo "N/A")
          OWNER_ID=$(echo "$JSON"    | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('data',{}).get('owner_id','N/A'))"     2>/dev/null || echo "N/A")
          PROP_ID=$(echo "$JSON"     | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('data',{}).get('property_id','N/A'))"  2>/dev/null || echo "N/A")

          echo "job_title=$JOB_TITLE"   >> $GITHUB_OUTPUT
          echo "job_desc=$JOB_DESC"     >> $GITHUB_OUTPUT
          echo "job_status=$JOB_STATUS" >> $GITHUB_OUTPUT
          echo "owner_id=$OWNER_ID"     >> $GITHUB_OUTPUT
          echo "prop_id=$PROP_ID"       >> $GITHUB_OUTPUT

          echo "HTTP $STATUS â€” Job: '$JOB_TITLE' | Owner: $OWNER_ID | Status: $JOB_STATUS"

      - name: Evaluate result and report
        run: |
          STATUS="${{ steps.bola_probe.outputs.status }}"
          JOB_TITLE="${{ steps.bola_probe.outputs.job_title }}"
          JOB_DESC="${{ steps.bola_probe.outputs.job_desc }}"
          JOB_STATUS="${{ steps.bola_probe.outputs.job_status }}"
          OWNER_ID="${{ steps.bola_probe.outputs.owner_id }}"
          PROP_ID="${{ steps.bola_probe.outputs.prop_id }}"

          if [ "$STATUS" = "SKIP" ] || [ -z "$STATUS" ]; then
            echo "## âš ï¸ API Not Reachable in CI" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The live API at \`${API_URL:-http://localhost:3001}\` was not reachable from the GitHub Actions runner." >> $GITHUB_STEP_SUMMARY
            echo "**To enable live probing:** Set the \`API_URL\` repository variable (Settings â†’ Variables) to a deployed staging URL." >> $GITHUB_STEP_SUMMARY
            echo "This check is **informational only** until a live API endpoint is configured." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          if [ "$STATUS" = "200" ]; then
            echo "::error::VULN-1 CONFIRMED: BOLA vulnerability detected! Bob (bob@propowner.com) accessed Alice's job '$JOB_TITLE' (owner_id: $OWNER_ID) using his own token. Server returned HTTP 200. Fix: add AND owner_id = \$2 to WHERE clause in JobService.getJobById()"

            echo "## ðŸ”´ BOLA Vulnerability Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Attacker:** Bob (bob@propowner.com) â€” a different property owner" >> $GITHUB_STEP_SUMMARY
            echo "**Victim resource owner:** Alice (alice@propowner.com)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Exposed Job Details" >> $GITHUB_STEP_SUMMARY
            echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|---|---|" >> $GITHUB_STEP_SUMMARY
            echo "| Job Title | $JOB_TITLE |" >> $GITHUB_STEP_SUMMARY
            echo "| Description | $JOB_DESC |" >> $GITHUB_STEP_SUMMARY
            echo "| Job Status | $JOB_STATUS |" >> $GITHUB_STEP_SUMMARY
            echo "| Owner ID | $OWNER_ID |" >> $GITHUB_STEP_SUMMARY
            echo "| Property ID | $PROP_ID |" >> $GITHUB_STEP_SUMMARY
            echo "| HTTP Response | $STATUS OK âœ… (should be 403) |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Fix:** Add ownership check in JobService.getJobById(): \`WHERE id = \$1 AND owner_id = \$2\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… BOLA check passed â€” server returned HTTP $STATUS (access denied)"
            echo "## âœ… BOLA Check Passed" >> $GITHUB_STEP_SUMMARY
            echo "Bob's request to access Alice's job was correctly rejected with HTTP $STATUS." >> $GITHUB_STEP_SUMMARY
          fi
